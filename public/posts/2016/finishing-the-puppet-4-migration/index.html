<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Finishing the Puppet 4 Migration | Daniel Schaaff</title>
<meta name="keywords" content="puppet, technology">
<meta name="description" content="Two days ago I finished our migration to Puppet 4. Overall I&rsquo;d say the process was pretty painless. The gist of what I did


start running rspec tests against Puppet 4


fix issues found in tests


run the catalog preview tool and fix any issues found


turn on the future parser on the existing master


turn off stringify facts


create new master and PuppeDB server


migrate agents to new master


Thankfully our code wasn&rsquo;t too difficult to update and most of the forge modules we use had also been updated.">
<meta name="author" content="dschaaff">
<link rel="canonical" href="http://localhost:1313/posts/2016/finishing-the-puppet-4-migration/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css" integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF&#43;13Dyqob6ASlTrTye8=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/2016/finishing-the-puppet-4-migration/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="http://localhost:1313/posts/2016/finishing-the-puppet-4-migration/">
  <meta property="og:site_name" content="Daniel Schaaff">
  <meta property="og:title" content="Finishing the Puppet 4 Migration">
  <meta property="og:description" content="Two days ago I finished our migration to Puppet 4. Overall I’d say the process was pretty painless. The gist of what I did
start running rspec tests against Puppet 4
fix issues found in tests
run the catalog preview tool and fix any issues found
turn on the future parser on the existing master
turn off stringify facts
create new master and PuppeDB server
migrate agents to new master
Thankfully our code wasn’t too difficult to update and most of the forge modules we use had also been updated.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2016-12-23T23:19:07+00:00">
    <meta property="article:modified_time" content="2016-12-23T23:19:07+00:00">
    <meta property="article:tag" content="Puppet">
    <meta property="article:tag" content="Technology">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Finishing the Puppet 4 Migration">
<meta name="twitter:description" content="Two days ago I finished our migration to Puppet 4. Overall I&rsquo;d say the process was pretty painless. The gist of what I did


start running rspec tests against Puppet 4


fix issues found in tests


run the catalog preview tool and fix any issues found


turn on the future parser on the existing master


turn off stringify facts


create new master and PuppeDB server


migrate agents to new master


Thankfully our code wasn&rsquo;t too difficult to update and most of the forge modules we use had also been updated.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Finishing the Puppet 4 Migration",
      "item": "http://localhost:1313/posts/2016/finishing-the-puppet-4-migration/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Finishing the Puppet 4 Migration",
  "name": "Finishing the Puppet 4 Migration",
  "description": "Two days ago I finished our migration to Puppet 4. Overall I\u0026rsquo;d say the process was pretty painless. The gist of what I did\nstart running rspec tests against Puppet 4\nfix issues found in tests\nrun the catalog preview tool and fix any issues found\nturn on the future parser on the existing master\nturn off stringify facts\ncreate new master and PuppeDB server\nmigrate agents to new master\nThankfully our code wasn\u0026rsquo;t too difficult to update and most of the forge modules we use had also been updated.\n",
  "keywords": [
    "puppet", "technology"
  ],
  "articleBody": "Two days ago I finished our migration to Puppet 4. Overall I’d say the process was pretty painless. The gist of what I did\nstart running rspec tests against Puppet 4\nfix issues found in tests\nrun the catalog preview tool and fix any issues found\nturn on the future parser on the existing master\nturn off stringify facts\ncreate new master and PuppeDB server\nmigrate agents to new master\nThankfully our code wasn’t too difficult to update and most of the forge modules we use had also been updated.\nCreating the New Master I did not want to upgrade our existing master for a variety of reasons I won’t get into here. Instead I took the opportunity to migrate it from an old vm to running on ec2 with PuppetDB in RDS. I have to give props to the puppet team for greatly simplifying the setup process of a new master in Puppet 4. Setting up puppetserver is significantly easier then the old passenger based server.\nMigrating the Agents Puppet provides a module to migrate your agents to the new master. It will copy the existing ssl certs to the new directory and upgrade the agent. I was not able to do this since I was not migrating certs to the new master (I needed to add new DNS alt names). The consequence of this was needing to find a way to upgrade and migrate the agents in an automated fashion. I accomplished this entirely with puppet! The process was\npre-create /etc/puppetlabs/puppet\ndrop a new config into /etc/puppetlabs.puppet/puppet.conf with the new master name\nsetup the puppetlabs puppet collection repo\ninstall the new puppet-agent package\nupdate cron job for new puppet paths (the fact that I already ran puppet using cron made this simple)\npurge the old /etc/puppet directory\nA puppet run would take place on the old master and prep things using the steps above. Then when the cronjob kicked in it would run against the new master and get a new cert issued. Overall this worked really well and we only had to touch 2 machines by hand.\nMigrate Puppet Manifest This is the manifest I used to migrate our linux machines. Available on GitHub here https://github.com/dschaaff/puppet-migrate.\nclass migrate { file {'/etc/puppetlabs': ensure =\u003e directory, } -\u003e file {'/etc/puppetlabs/puppet': ensure =\u003e directory, } -\u003e file {'/etc/puppetlabs/puppet/puppet.conf': ensure =\u003e present, source =\u003e 'puppet:///modules/migrate/puppet.conf' } if $facts['osfamily'] == 'Debian' { include apt apt::source { 'puppetlabs-pc1': location =\u003e 'http://apt.puppetlabs.com', repos =\u003e 'PC1', key =\u003e { 'id' =\u003e '6F6B15509CF8E59E6E469F327F438280EF8D349F', 'server' =\u003e 'pgp.mit.edu', }, notify =\u003e Class['apt::update'] } package {'puppet-agent': ensure =\u003e present, require =\u003e Class['apt::update'] } } if $facts['osfamily'] == 'RedHat' { $version = $facts['operatingsystemmajrelease'] yumrepo {'puppetlabs-pc1': baseurl =\u003e \"https://yum.puppetlabs.com/el/${version}/PC1/\\$basearch\", descr =\u003e 'Puppetlabs PC1 Repository', enabled =\u003e true, gpgcheck =\u003e '1', gpgkey =\u003e 'https://yum.puppetlabs.com/RPM-GPG-KEY-puppetlabs' } -\u003e package {'puppet-agent': ensure =\u003e present, } } $time1 = fqdn_rand(30) $time2 = $time1 + 30 $minute = [ $time1, $time2 ] cron {'puppet-agent': command =\u003e '/opt/puppetlabs/bin/puppet agent --no-daemonize --onetime --logdest syslog \u003e /dev/null 2\u003e\u00261', user =\u003e 'root', hour =\u003e '*', minute =\u003e $minute, } -\u003e cron {'puppet-client': ensure =\u003e 'absent', command =\u003e '/usr/bin/puppet agent --no-daemonize --onetime --logdest syslog \u003e /dev/null 2\u003e\u00261', user =\u003e 'root', hour =\u003e '*', minute =\u003e $minute, } file {'/etc/puppet': ensure =\u003e purged, force =\u003e true, } -\u003e file { '/var/lib/puppet/ssl': ensure =\u003e purged, force =\u003e true, } } I used a similar manifest for macOS\nclass migrate::mac { $mac_vers = $facts['macosx_productversion_major'] file {'/etc/puppetlabs': ensure =\u003e directory, } -\u003e file {'/etc/puppetlabs/puppet': ensure =\u003e directory, } -\u003e file {'/etc/puppetlabs/puppet/puppet.conf': ensure =\u003e present, source =\u003e 'puppet:///modules/migrate/puppet.conf' } package {\"puppet-agent-1.8.2-1.osx${mac_vers}.dmg\": ensure =\u003e present, source =\u003e \"https://downloads.puppetlabs.com/mac/${mac_vers}/PC1/x86_64/puppet-agent-1.8.2-1.osx${mac_vers}.dmg\" } $time1 = fqdn_rand(30) $time2 = $time1 + 30 $minute = [ $time1, $time2 ] cron {'puppet-agent': command =\u003e '/opt/puppetlabs/bin/puppet agent --no-daemonize --onetime --logdest syslog \u003e /dev/null 2\u003e\u00261', user =\u003e 'root', hour =\u003e '*', minute =\u003e $minute, } file {'/etc/puppet': ensure =\u003e purged, force =\u003e true, } -\u003e file { '/var/lib/puppet/ssl': ensure =\u003e purged, force =\u003e true, } -\u003e # using gem since puppet 3.8 did not have packages for Sierra package {'puppet': ensure =\u003e absent, provider =\u003e 'gem', } } Post Migration Experience After migrating the agents I only ran into one piece of code that broke due to the upgrade. Somehow I had overlooked the removal of dynamic scoping in ERB templates. This piece of code was not covered by rspec tests, an area for improvement! I relied on this to configure logstash output to elasticsearch. Under Puppet 3 the relevant piece of ERB looked like this\noutput { if [type] == \"syslog\" { elasticsearch { hosts =\u003e [\u003c%= @es_input_nodes.collect { |node| '\"' + node.to_s + ':' + @elasticsearch_port.to_s + '\"' }.join(',') %\u003e] ssl =\u003e true } } The value of es_input_nodes was pulled from the params class\nclass elk::logstash ( $syslog_port = $elk::params::syslog_port, $elasticsearch_nodes = $elk::params::elasticsearch_nodes, $es_input_nodes = $elk::params::es_input_nodes, $elasticsearch_port = $elk::params::elasticsearch_port, $netflow_port = $elk::params::netflow_port ) The params class pulls the info from Puppet DB.\n$es_input_nodes = sort(query_nodes('Class[Elk::elasticsearch] and elasticsearchrole=data or elasticsearchrole=client')) The removal of dynamic scoping templates meant the template was putting empty values in the logstash config and breaking the service. To fix the variables needed to be scoped properly in the template and now look like this\noutput { if [type] == \"syslog\" { elasticsearch { hosts =\u003e [\u003c%= scope['elk::logstash::es_input_nodes'].collect { |node| '\"' + node.to_s + ':' + scope['elk::logstash::elasticsearch_port'].to_s + '\"' }.join(',') %\u003e] ssl =\u003e true } } Remaining Work Prior to the migration I relied on stephenrjohnson/pupptmodule to manage the puppet agent on Linux and macOS. Some work has been done on Puppet 4 compatability but there is still more to do. I’m close to updating the agent pieces for my needs but there is a lot of work to add puppet master support.\n",
  "wordCount" : "951",
  "inLanguage": "en",
  "datePublished": "2016-12-23T23:19:07Z",
  "dateModified": "2016-12-23T23:19:07Z",
  "author":{
    "@type": "Person",
    "name": "dschaaff"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/2016/finishing-the-puppet-4-migration/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Daniel Schaaff",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Daniel Schaaff (Alt + H)">Daniel Schaaff</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/cv/" title="CV">
                    <span>CV</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Finishing the Puppet 4 Migration
    </h1>
    <div class="post-meta"><span title='2016-12-23 23:19:07 +0000 UTC'>December 23, 2016</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;dschaaff

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#creating-the-new-master" aria-label="Creating the New Master">Creating the New Master</a></li>
                <li>
                    <a href="#migrating-the-agents" aria-label="Migrating the Agents">Migrating the Agents</a><ul>
                        
                <li>
                    <a href="#migrate-puppet-manifest" aria-label="Migrate Puppet Manifest">Migrate Puppet Manifest</a></li>
                <li>
                    <a href="#post-migration-experience" aria-label="Post Migration Experience">Post Migration Experience</a></li></ul>
                </li>
                <li>
                    <a href="#remaining-work" aria-label="Remaining Work">Remaining Work</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>Two days ago I finished our migration to Puppet 4. Overall I&rsquo;d say the process was pretty painless. The gist of what I did</p>
<ul>
<li>
<p>start running rspec tests against Puppet 4</p>
</li>
<li>
<p>fix issues found in tests</p>
</li>
<li>
<p>run the <a href="https://github.com/dschaaff/prosvc-preview_report">catalog preview tool</a> and fix any issues found</p>
</li>
<li>
<p>turn on the future parser on the existing master</p>
</li>
<li>
<p>turn off stringify facts</p>
</li>
<li>
<p>create new master and PuppeDB server</p>
</li>
<li>
<p>migrate agents to new master</p>
</li>
</ul>
<p>Thankfully our code wasn&rsquo;t too difficult to update and most of the forge modules we use had also been updated.</p>
<h2 id="creating-the-new-master">Creating the New Master<a hidden class="anchor" aria-hidden="true" href="#creating-the-new-master">#</a></h2>
<p>I did not want to upgrade our existing master for a variety of reasons I won&rsquo;t get into here. Instead I took the opportunity to migrate it from an old vm to running on ec2 with PuppetDB in RDS. I have to give props to the puppet team for greatly simplifying the setup process of a new master in Puppet 4. Setting up puppetserver is significantly easier then the old passenger based server.</p>
<h2 id="migrating-the-agents">Migrating the Agents<a hidden class="anchor" aria-hidden="true" href="#migrating-the-agents">#</a></h2>
<p>Puppet provides a <a href="https://forge.puppet.com/puppetlabs/puppet_agent">module</a> to migrate your agents to the new master. It will copy the existing ssl certs to the new directory and upgrade the agent. I was not able to do this since I was not migrating certs to the new master (I needed to add new DNS alt names). The consequence of this was needing to find a way to upgrade and migrate the agents in an automated fashion. I accomplished this entirely with puppet! The process was</p>
<ul>
<li>
<p>pre-create <code>/etc/puppetlabs/puppet</code></p>
</li>
<li>
<p>drop a new config into <code>/etc/puppetlabs.puppet/puppet.conf</code> with the new master name</p>
</li>
<li>
<p>setup the puppetlabs puppet collection repo</p>
</li>
<li>
<p>install the new puppet-agent package</p>
</li>
<li>
<p>update cron job for new puppet paths (the fact that I already ran puppet using cron made this simple)</p>
</li>
<li>
<p>purge the old <code>/etc/puppet</code> directory</p>
</li>
</ul>
<p>A puppet run would take place on the old master and prep things using the steps above. Then when the cronjob kicked in it would run against the new master and get a new cert issued. Overall this worked really well and we only had to touch 2 machines by hand.</p>
<h3 id="migrate-puppet-manifest">Migrate Puppet Manifest<a hidden class="anchor" aria-hidden="true" href="#migrate-puppet-manifest">#</a></h3>
<p>This is the manifest I used to migrate our linux machines. Available on GitHub here <a href="https://github.com/dschaaff/puppet-migrate">https://github.com/dschaaff/puppet-migrate</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="k">class</span> <span class="n">migrate</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/etc/puppetlabs&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">directory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/etc/puppetlabs/puppet&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">directory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/etc/puppetlabs/puppet/puppet.conf&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">source</span> <span class="o">=&gt;</span> <span class="s1">&#39;puppet:///modules/migrate/puppet.conf&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vg">$facts</span><span class="o">[</span><span class="s1">&#39;osfamily&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;Debian&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="kp">include</span> <span class="n">apt</span>
</span></span><span class="line"><span class="cl"><span class="n">apt</span><span class="o">::</span><span class="n">source</span> <span class="p">{</span> <span class="s1">&#39;puppetlabs-pc1&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">location</span> <span class="o">=&gt;</span> <span class="s1">&#39;http://apt.puppetlabs.com&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">repos</span>    <span class="o">=&gt;</span> <span class="s1">&#39;PC1&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span>      <span class="o">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;id&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;6F6B15509CF8E59E6E469F327F438280EF8D349F&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;server&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;pgp.mit.edu&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="n">notify</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;apt::update&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">package</span> <span class="p">{</span><span class="s1">&#39;puppet-agent&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;apt::update&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vg">$facts</span><span class="o">[</span><span class="s1">&#39;osfamily&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;RedHat&#39;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="vg">$version</span> <span class="o">=</span> <span class="vg">$facts</span><span class="o">[</span><span class="s1">&#39;operatingsystemmajrelease&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="n">yumrepo</span> <span class="p">{</span><span class="s1">&#39;puppetlabs-pc1&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">baseurl</span>  <span class="o">=&gt;</span> <span class="s2">&#34;https://yum.puppetlabs.com/el/${version}/PC1/\$basearch&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">descr</span>    <span class="o">=&gt;</span> <span class="s1">&#39;Puppetlabs PC1 Repository&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">enabled</span>  <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">gpgcheck</span> <span class="o">=&gt;</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">gpgkey</span>   <span class="o">=&gt;</span> <span class="s1">&#39;https://yum.puppetlabs.com/RPM-GPG-KEY-puppetlabs&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">package</span> <span class="p">{</span><span class="s1">&#39;puppet-agent&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="vg">$time1</span> <span class="o">=</span> <span class="n">fqdn_rand</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="vg">$time2</span> <span class="o">=</span> <span class="vg">$time1</span> <span class="o">+</span> <span class="mi">30</span>
</span></span><span class="line"><span class="cl"><span class="vg">$minute</span> <span class="o">=</span> <span class="o">[</span> <span class="vg">$time1</span><span class="p">,</span> <span class="vg">$time2</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cron</span> <span class="p">{</span><span class="s1">&#39;puppet-agent&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">command</span> <span class="o">=&gt;</span> <span class="s1">&#39;/opt/puppetlabs/bin/puppet agent --no-daemonize --onetime --logdest syslog &gt; /dev/null 2&gt;&amp;1&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">user</span>    <span class="o">=&gt;</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">hour</span>    <span class="o">=&gt;</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">minute</span>  <span class="o">=&gt;</span> <span class="vg">$minute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">cron</span> <span class="p">{</span><span class="s1">&#39;puppet-client&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="s1">&#39;absent&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">command</span> <span class="o">=&gt;</span> <span class="s1">&#39;/usr/bin/puppet agent --no-daemonize --onetime --logdest syslog &gt; /dev/null 2&gt;&amp;1&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">user</span>    <span class="o">=&gt;</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">hour</span>    <span class="o">=&gt;</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">minute</span>  <span class="o">=&gt;</span> <span class="vg">$minute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/etc/puppet&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">purged</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">force</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;/var/lib/puppet/ssl&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">purged</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">force</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>I used a similar manifest for macOS</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="k">class</span> <span class="n">migrate</span><span class="o">::</span><span class="n">mac</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="vg">$mac_vers</span> <span class="o">=</span> <span class="vg">$facts</span><span class="o">[</span><span class="s1">&#39;macosx_productversion_major&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/etc/puppetlabs&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">directory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/etc/puppetlabs/puppet&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">directory</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/etc/puppetlabs/puppet/puppet.conf&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">source</span> <span class="o">=&gt;</span> <span class="s1">&#39;puppet:///modules/migrate/puppet.conf&#39;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">package</span> <span class="p">{</span><span class="s2">&#34;puppet-agent-1.8.2-1.osx${mac_vers}.dmg&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">source</span> <span class="o">=&gt;</span> <span class="s2">&#34;https://downloads.puppetlabs.com/mac/${mac_vers}/PC1/x86_64/puppet-agent-1.8.2-1.osx${mac_vers}.dmg&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="vg">$time1</span> <span class="o">=</span> <span class="n">fqdn_rand</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="vg">$time2</span> <span class="o">=</span> <span class="vg">$time1</span> <span class="o">+</span> <span class="mi">30</span>
</span></span><span class="line"><span class="cl"><span class="vg">$minute</span> <span class="o">=</span> <span class="o">[</span> <span class="vg">$time1</span><span class="p">,</span> <span class="vg">$time2</span> <span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cron</span> <span class="p">{</span><span class="s1">&#39;puppet-agent&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="n">command</span> <span class="o">=&gt;</span> <span class="s1">&#39;/opt/puppetlabs/bin/puppet agent --no-daemonize --onetime --logdest syslog &gt; /dev/null 2&gt;&amp;1&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">user</span>    <span class="o">=&gt;</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">hour</span>    <span class="o">=&gt;</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">minute</span>  <span class="o">=&gt;</span> <span class="vg">$minute</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">file</span> <span class="p">{</span><span class="s1">&#39;/etc/puppet&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">purged</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">force</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">file</span> <span class="p">{</span> <span class="s1">&#39;/var/lib/puppet/ssl&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">purged</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">force</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># using gem since puppet 3.8 did not have packages for Sierra</span>
</span></span><span class="line"><span class="cl"><span class="n">package</span> <span class="p">{</span><span class="s1">&#39;puppet&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">absent</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="n">provider</span> <span class="o">=&gt;</span> <span class="s1">&#39;gem&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="post-migration-experience">Post Migration Experience<a hidden class="anchor" aria-hidden="true" href="#post-migration-experience">#</a></h3>
<p>After migrating the agents I only ran into one piece of code that broke due to the upgrade. Somehow I had overlooked the <a href="https://docs.puppet.com/puppet/latest/lang_updating_manifests.html#dynamic-scoping-in-erb">removal of dynamic scoping in ERB templates</a>. This piece of code was not covered by rspec tests, an area for improvement! I relied on this to configure logstash output to elasticsearch. Under Puppet 3 the relevant piece of ERB looked like this</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="n">output</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span><span class="n">type</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&#34;syslog&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">elasticsearch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">hosts</span> <span class="o">=&gt;</span> <span class="o">[&lt;</span><span class="s">%= @es_input_nodes.collect { |node| &#39;&#34;&#39; + node.to_s + &#39;:&#39; + @elasticsearch_port.to_s + &#39;&#34;&#39; }.join(&#39;,&#39;) %&gt;]
</span></span></span><span class="line"><span class="cl"><span class="s">ssl =</span><span class="o">&gt;</span> <span class="kp">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The value of <code>es_input_nodes</code> was pulled from the params class</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="k">class</span> <span class="n">elk</span><span class="o">::</span><span class="n">logstash</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="vg">$syslog_port</span> <span class="o">=</span> <span class="vg">$elk</span><span class="o">::</span><span class="n">params</span><span class="o">::</span><span class="n">syslog_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="vg">$elasticsearch_nodes</span> <span class="o">=</span> <span class="vg">$elk</span><span class="o">::</span><span class="n">params</span><span class="o">::</span><span class="n">elasticsearch_nodes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="vg">$es_input_nodes</span> <span class="o">=</span> <span class="vg">$elk</span><span class="o">::</span><span class="n">params</span><span class="o">::</span><span class="n">es_input_nodes</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="vg">$elasticsearch_port</span> <span class="o">=</span> <span class="vg">$elk</span><span class="o">::</span><span class="n">params</span><span class="o">::</span><span class="n">elasticsearch_port</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="vg">$netflow_port</span> <span class="o">=</span> <span class="vg">$elk</span><span class="o">::</span><span class="n">params</span><span class="o">::</span><span class="n">netflow_port</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>The params class pulls the info from Puppet DB.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="vg">$es_input_nodes</span> <span class="o">=</span> <span class="n">sort</span><span class="p">(</span><span class="n">query_nodes</span><span class="p">(</span><span class="s1">&#39;Class[Elk::elasticsearch] and elasticsearchrole=data or elasticsearchrole=client&#39;</span><span class="p">))</span>
</span></span></code></pre></div><p>The removal of dynamic scoping templates meant the template was putting empty values in the logstash config and breaking the service. To fix the variables needed to be scoped properly in the template and now look like this</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="n">output</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span><span class="n">type</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&#34;syslog&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">elasticsearch</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">hosts</span> <span class="o">=&gt;</span> <span class="o">[&lt;</span><span class="s">%= scope[&#39;elk::logstash::es_input_nodes&#39;].collect { |node| &#39;&#34;&#39; + node.to_s + &#39;:&#39; + scope[&#39;elk::logstash::elasticsearch_port&#39;].to_s + &#39;&#34;&#39; }.join(&#39;,&#39;) %&gt;]
</span></span></span><span class="line"><span class="cl"><span class="s">ssl =</span><span class="o">&gt;</span> <span class="kp">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="remaining-work">Remaining Work<a hidden class="anchor" aria-hidden="true" href="#remaining-work">#</a></h2>
<p>Prior to the migration I relied on <a href="https://github.com/stephenrjohnson/puppetmodule">stephenrjohnson/pupptmodule</a> to manage the puppet agent on Linux and macOS. Some work has been done on Puppet 4 compatability but there is still more to do. I&rsquo;m close to updating the <a href="https://github.com/dschaaff/puppetmodule">agent pieces</a> for my needs but there is a lot of work to add puppet master support.</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/puppet/">Puppet</a></li>
      <li><a href="http://localhost:1313/tags/technology/">Technology</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/2017/automated-puppet-tests-with-bamboo/">
    <span class="title">« Prev</span>
    <br>
    <span>Automated Puppet Tests with Bamboo</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/2016/code-keyboard-tenkeyless-massdrop/">
    <span class="title">Next »</span>
    <br>
    <span>Code Keyboard Tenkeyless - Massdrop</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">Daniel Schaaff</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
